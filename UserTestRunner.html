<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Test Runner - Professional</title>
<style>
body {margin:0;font-family:Arial,sans-serif;display:flex;height:100vh;background:#f5f7fb;overflow:hidden}
#testSelectPanel {width:300px;background:#fff;padding:20px;box-shadow:2px 0 8px rgba(0,0,0,0.1);overflow-y:auto}
#runnerPanel {flex:1;display:flex;flex-direction:column;overflow:hidden}
h1,h2,h3,h4,p{margin:0 0 10px 0}
.test-btn {display:block;width:100%;padding:10px;margin-bottom:6px;border:none;border-radius:6px;background:#111827;color:#fff;cursor:pointer;text-align:left;font-weight:600;transition:0.2s}
.test-btn:hover {background:#1f2937}
#sidebar {width:220px;background:#fff;padding:16px;overflow-y:auto;box-shadow:2px 0 6px rgba(0,0,0,0.1)}
#sectionsList {margin-bottom:12px}
.section-btn {display:block;width:100%;padding:6px;margin-bottom:4px;border:none;border-radius:6px;background:#e5e7eb;color:#111827;cursor:pointer;font-weight:600;transition:0.2s;text-align:left}
.section-btn.current {background:#3b82f6;color:#fff}
.section-btn:hover {background:#60a5fa;color:#fff}
#questionList {display:flex;flex-wrap:wrap;gap:4px}
.sidebar-question-btn {width:40px;height:40px;margin-bottom:4px;padding:6px;border:none;border-radius:4px;cursor:pointer;text-align:center;font-size:0.9em;transition:0.2s}
.sidebar-question-btn.answered {background:#3b82f6;color:#fff}
.sidebar-question-btn.correct {background:#16a34a;color:#fff}
.sidebar-question-btn.incorrect {background:#ef4444;color:#fff}
.sidebar-question-btn.current {outline:2px solid #111827}
#main {flex:1;padding:16px;display:flex;flex-direction:column;overflow-y:auto}
.question-card {background:#fff;padding:16px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.1);margin-bottom:12px}
.question-card img {max-width:250px;max-height:150px;object-fit:contain;border-radius:6px;cursor:pointer;margin-bottom:8px;transition:0.2s}
.question-card img:hover {transform:scale(1.05)}
.options button {display:block;width:100%;margin:6px 0;padding:8px;border:none;border-radius:6px;text-align:left;cursor:pointer;transition:0.2s}
.options button.selected {background:#3b82f6;color:#fff}
.options button.correct {background:#16a34a;color:#fff}
.options button.incorrect {background:#ef4444;color:#fff}
.nav-buttons {margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
.nav-buttons button {padding:8px 12px;border:none;border-radius:6px;background:#111827;color:#fff;cursor:pointer;transition:0.2s}
.nav-buttons button:hover {background:#1f2937}
.nav-buttons button:disabled {background:#9ca3af;cursor:not-allowed}
.timer {font-weight:bold;font-size:1.2em;margin-bottom:12px}
#modal {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.75);justify-content:center;align-items:center;z-index:50;cursor:pointer}
#modal img {max-width:90%;max-height:90%;border-radius:10px}
.summary {background:#fff;padding:12px;margin-top:12px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.1)}
.summary h4 {margin-bottom:6px}
</style>
</head>
<body>

<div id="testSelectPanel">
  <h2>Select a Test</h2>
  <div id="testList"></div>
</div>

<div id="runnerPanel" style="display:none">
  <div style="display:flex;flex:1;overflow:hidden">
    <div id="sidebar">
      <div id="sectionsList"></div>
      <div id="questionList"></div>
    </div>
    <div id="main">
      <div class="timer" id="timer">00:00</div>
      <div id="questionContainer"></div>
      <div class="nav-buttons">
        <button id="prevBtn">Previous</button>
        <button id="nextBtn">Next</button>
        <button id="submitBtn">Submit</button>
        <button id="reattemptBtn" style="display:none">Reattempt</button>
      </div>
    </div>
  </div>
</div>

<div id="modal" onclick="closeModal()">
  <img id="modalImage" src="" alt="Full Image">
</div>

<script>
let tests = [];
try {
  const raw = localStorage.getItem('admin_tests_v1');
  if(raw) tests = JSON.parse(raw);
} catch(e){console.error('Failed to load tests:', e);}

const testListEl = document.getElementById('testList');
const runnerPanel = document.getElementById('runnerPanel');
const sidebar = document.getElementById('sidebar');
const sectionsList = document.getElementById('sectionsList');
const questionList = document.getElementById('questionList');
const main = document.getElementById('main');
const questionContainer = document.getElementById('questionContainer');
const timerEl = document.getElementById('timer');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const submitBtn = document.getElementById('submitBtn');
const reattemptBtn = document.getElementById('reattemptBtn');

let selectedTestIndex = null;
let currentSectionIndex = 0;
let currentQuestionIndex = 0;
let answers = {};
let submitted = false;
let timeLeft = 0;
let timerInterval = null;

function renderTestList(){
  testListEl.innerHTML='';
  if(tests.length===0){ testListEl.innerHTML='<p style="color:#555">No tests available.</p>'; return;}
  tests.forEach((t,i)=>{
    const btn = document.createElement('button');
    btn.className='test-btn';
    const mins = Math.floor(t.duration/60);
    const secs = t.duration % 60;
    const timeStr = `${mins}m ${secs}s`;
    btn.textContent= t.title + ' (' + timeStr + ')';
    btn.onclick = ()=>startTest(i);
    testListEl.appendChild(btn);
  });
}

function startTest(idx){
  selectedTestIndex=idx;
  document.getElementById('testSelectPanel').style.display='none';
  runnerPanel.style.display='flex';
  currentSectionIndex=0;
  currentQuestionIndex=0;
  answers={};
  submitted=false;
  const test = tests[selectedTestIndex];
  timeLeft = test.duration;
  startTimer();
  renderSidebar();
  renderQuestion();
}

function startTimer(){
  clearInterval(timerInterval);
  updateTimer();
  timerInterval = setInterval(()=>{
    if(timeLeft<=0){ clearInterval(timerInterval); submitTest(); }
    else { timeLeft--; updateTimer(); }
  },1000);
}

function updateTimer(){
  const m=Math.floor(timeLeft/60).toString().padStart(2,'0');
  const s=(timeLeft%60).toString().padStart(2,'0');
  timerEl.textContent = `${m}:${s}`;
}

function renderSidebar(){
  sectionsList.innerHTML='';
  questionList.innerHTML='';
  const test = tests[selectedTestIndex];

  test.sections.forEach((s,i)=>{
    const btn = document.createElement('button');
    btn.textContent = s.title;
    btn.className='section-btn';
    if(i===currentSectionIndex) btn.classList.add('current');
    btn.onclick=()=>{currentSectionIndex=i;currentQuestionIndex=0;renderSidebar();renderQuestion();}
    sectionsList.appendChild(btn);
  });

  const section = test.sections[currentSectionIndex];
  section.questions.forEach((q,i)=>{
    const btn = document.createElement('button');
    btn.textContent=i+1;
    btn.className='sidebar-question-btn';
    if(answers[q.id]!==undefined && !submitted) btn.classList.add('answered');
    if(submitted){
      if(answers[q.id]===q.correctAnswerIndex) btn.classList.add('correct');
      else if(answers[q.id]!==undefined) btn.classList.add('incorrect');
    }
    if(i===currentQuestionIndex) btn.classList.add('current');
    btn.onclick=()=>{currentQuestionIndex=i;renderQuestion();}
    questionList.appendChild(btn);
  });
}

function renderQuestion(){
  const test = tests[selectedTestIndex];
  const section = test.sections[currentSectionIndex];
  const question = section.questions[currentQuestionIndex];
  if(!question) return;

  let html=`<div class="question-card">
    <h3>Q${currentQuestionIndex+1}: ${question.text}</h3>`;

  if(question.image){
    let imgSrc = question.image.startsWith('data:') ? question.image : question.image;
    html+=`<img src="${imgSrc}" alt="Q Image" onclick="openModal('${imgSrc.replace(/'/g,"\\'")}')">`;
  }

  html+='<div class="options">';
  question.options.forEach((opt,idx)=>{
    let cls='';
    if(submitted){
      if(answers[question.id]===idx) cls=idx===question.correctAnswerIndex?'correct':'incorrect';
      else if(idx===question.correctAnswerIndex) cls='correct';
    } else {
      if(answers[question.id]===idx) cls='selected';
    }
    html+=`<button class="${cls}" onclick="selectAnswer(${question.id},${idx})">${opt}</button>`;
  });
  html+='</div>';

  if(submitted){
    const ansIdx = answers[question.id];
    const status = ansIdx === question.correctAnswerIndex ? 'Correct' : 'Wrong';
    html+=`<div class="summary">
      <p>Your Answer: ${ansIdx!==undefined ? question.options[ansIdx] : 'Not Answered'}</p>
      <p>Correct Answer: ${question.options[question.correctAnswerIndex]}</p>
      <p>Status: <strong>${status}</strong></p>
    </div>`;
  }

  html+='</div>';
  questionContainer.innerHTML=html;
  renderSidebar();
  updateNavButtons();
}

function selectAnswer(qId,optIdx){
  if(submitted) return;
  answers[qId]=optIdx;
  renderQuestion();
}

function prevQuestion(){if(currentQuestionIndex>0){currentQuestionIndex--;renderQuestion();}}
function nextQuestion(){const section = tests[selectedTestIndex].sections[currentSectionIndex]; if(currentQuestionIndex<section.questions.length-1){currentQuestionIndex++;renderQuestion();}}

function updateNavButtons(){
  const section = tests[selectedTestIndex].sections[currentSectionIndex];
  prevBtn.disabled=currentQuestionIndex===0;
  nextBtn.disabled=currentQuestionIndex===section.questions.length-1;
  submitBtn.disabled=submitted;
  reattemptBtn.style.display=submitted?'inline-block':'none';
}

function submitTest(){
  submitted=true;
  clearInterval(timerInterval);
  renderQuestion();
  alert('Test submitted!');
}

function reattemptTest(){
  answers={};
  submitted=false;
  const test = tests[selectedTestIndex];
  timeLeft=test.duration;
  currentSectionIndex=0;
  currentQuestionIndex=0;
  renderSidebar();
  renderQuestion();
  startTimer();
}

function openModal(src){
  document.getElementById('modalImage').src=src;
  document.getElementById('modal').style.display='flex';
}
function closeModal(){document.getElementById('modal').style.display='none'}

prevBtn.onclick=prevQuestion;
nextBtn.onclick=nextQuestion;
submitBtn.onclick=submitTest;
reattemptBtn.onclick=reattemptTest;

window.onload=()=>{renderTestList();}
</script>
</body>
</html>
